<html>
    <head>
        <title>My first Three.js app</title> <style>canvas { width: 100%; height: 100% } html,body { margin: 0; padding: 0; }</style>
    </head> 
<body>
    <script src="three.min.js"></script>
    <!-- Shaders -->
    <script type="x-shader/x-vertex" id="vertexshader">
        uniform float amplitude;
        attribute float size;
        attribute vec3 customColor;

        varying vec3 vColor;

        void main() {

            vColor = customColor;

            vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );

            //gl_PointSize = size;
            gl_PointSize = size * ( 300.0 / length( mvPosition.xyz ) );

            gl_Position = projectionMatrix * mvPosition;

        }
    </script>
    <script type="x-shader/x-fragment" id="fragmentshader">
        uniform vec3 color;
        uniform sampler2D texture;

        varying vec3 vColor;

        void main() {

            gl_FragColor = vec4( color * vColor, 1.0 );
            gl_FragColor = gl_FragColor * texture2D( texture, gl_PointCoord );

        }
    </script>
    <!-- /Shaders -->
    <script>

    	var scene;
    	var container;
    	var camera;
    	var renderer;
    	var loader;
    	var mesh;

        var sphere, uniforms, attributes;
        var noise = [];

    	function init() {

    		camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 100000 );
            camera.position.z = 100;
	    	scene = new THREE.Scene();


	    	container = document.createElement( 'div' );
	    	document.body.appendChild( container );

	    	renderer = new THREE.WebGLRenderer({
                antialias: true,
                clearColor: 0x000000,
                clearAlpha: 1
            });
	    	renderer.setSize( window.innerWidth, window.innerHeight );
	    	container.appendChild( renderer.domElement );

	    	loader = new THREE.JSONLoader();
	    	loader.load('ya4.js', function (geometry, materials) {
                var material = new THREE.MeshFaceMaterial( materials );
                mesh = new THREE.Mesh( geometry, material );
                mesh.scale.set( 10, 10, 10 );
                mesh.position.set( 1, 1, 1 );
                mesh.rotation.x = 1.5;
                scene.add( mesh );
            });

			var ambientLight = new THREE.AmbientLight( 0xffffff );
			scene.add( ambientLight );


            // World
            attributes = {
                size: { type: 'f', value: [] },
                customColor: { type: 'c', value: [] }
            };

            uniforms = {
                amplitude: { type: "f", value: 1.0 },
                color:     { type: "c", value: new THREE.Color( 0xffffff ) },
                texture:   { type: "t", value: THREE.ImageUtils.loadTexture( "spark.png" ) },
            };

            var shaderMaterial = new THREE.ShaderMaterial( {
                uniforms:       uniforms,
                attributes:     attributes,
                vertexShader:   document.getElementById( 'vertexshader' ).textContent,
                fragmentShader: document.getElementById( 'fragmentshader' ).textContent,
                blending:       THREE.AdditiveBlending,
                depthTest:      false,
                transparent:    true
            });

            var radius = 150;
            var geometry = new THREE.Geometry();
            for ( var i = 0; i < 50000; i++ ) {
                var vertex = new THREE.Vector3();
                vertex.x = Math.random() * 2 - 1;
                vertex.y = Math.random() * 2 - 1;
                vertex.z = Math.random() * 2 - 1;
                vertex.multiplyScalar( radius );
                geometry.vertices.push( vertex );
            }

            sphere = new THREE.ParticleSystem( geometry, shaderMaterial );
            sphere.dynamic = true;

            var vertices = sphere.geometry.vertices;
            var values_size = attributes.size.value;
            var values_color = attributes.customColor.value;

            for( var v = 0; v < vertices.length; v++ ) {
                values_size[ v ] = 10;
                values_color[ v ] = new THREE.Color( 0x0000ff );
                values_color[ v ].setHSV( 0.1 + 0.9 * ( v / vertices.length ), 0.8, 0.4 );
            }

            scene.add( sphere );

		};


    	function animate() {
    		requestAnimationFrame(animate);
            var time = Date.now() * 0.005;

            sphere.rotation.z = 0.01 * time;
            for( var i = 0; i < attributes.size.value.length; i++ ) {
                attributes.size.value[ i ] = 14 + 13 * Math.sin( 0.1 * i + time );
            }

            //mesh.rotation.x = Math.sin(time*0.2);

            camera.rotation.y = Math.sin(time*0.01);
            
            camera.position.x = Math.sin(time*0.1)*100;
            camera.position.z = Math.cos(time*0.1)+50;
            camera.position.y = Math.sin(time*0.1)*20;


            attributes.size.needsUpdate = true;

            camera.lookAt(scene.position);

            renderer.render( scene, camera );
    	};

    	init();
    	animate();
    </script>
</body>
</html>